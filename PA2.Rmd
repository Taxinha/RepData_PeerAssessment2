---
title: "RepData - Peer Assessment 2"
author: "Carlos Correia"
date: "23 November 2014"
output:
  html_document:
    keep_md: yes
---

## Synopsis

## Data Processing

### Loading Libraries and defining global variables
```{r library}
library(dplyr)
library(reshape2)
library(ggplot2)
library(grid)
library(gridExtra)

fileURL      <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
localZipFile <- "./data/storm_data.csv.bz2"
inputRmdFile <- "PA2.Rmd"
```

### Helper functions
```{r helperFunctions}
## Download and Extract Zip data file
downloadAndExtractZipFile <- function(fileName){
  ## check if the data folder exists
  if(!file.exists("data")){
    dir.create("data")
  }
    
  ## check if zip file exists - if not download the zip file with the data
  if(!file.exists(fileName)){
    download.file(fileURL, destfile = fileName, method = "curl")
  }
}

## Reads the CSV data file
readCSVFile <- function(fileName, ...){
  if(! file.exists(fileName)){
    stop(paste("readDataFile: File ", fileName, " doesn't exist"))
  }
  
  print(paste("Reading file ", fileName))
  read.csv(fileName, ...)
}

## Cleanup and normalize the EVTYPE
cleanupEVTYPE <- function(input){
  output <- input %>%
    toupper() %>%
    gsub(pattern = "^\\t+", replacement = "", perl = TRUE) %>%
    gsub(pattern = "^\\s+", replacement = "", perl = TRUE) %>%
    gsub(pattern = "^AVALANCE.+", replacement = "AVALANCHE", perl = TRUE) %>%
    gsub(pattern = "^BLIZZARD.+", replacement = "BLIZZARD", perl = TRUE) %>%
    gsub(pattern = "^COASTAL FLOOD.+", replacement = "COASTAL FLOOD", perl = TRUE) %>%
    gsub(pattern = "^COASTAL  FLOODING/EROSION$", replacement = "COASTAL FLOOD", perl = TRUE) %>%
    gsub(pattern = "^COASTALSTORM", replacement = "COASTAL STORM", perl = TRUE) %>%
    gsub(pattern = "^COLD.+", replacement = "COLD", perl = TRUE) %>%
    gsub(pattern = "^COOL AND WET$", replacement = "COLD", perl = TRUE) %>%
    gsub(pattern = "^DROUGHT.+", replacement = "DROUGHT", perl = TRUE) %>%
    gsub(pattern = "^DRY MIRCOBURST WINDS$", replacement = "DRY MIRCOBURST", perl = TRUE) %>%
    gsub(pattern = "^DUST DEVIL.+", replacement = "DUST DEVIL", perl = TRUE) %>%
    gsub(pattern = "^DUST STORM.+", replacement = "DUST STORM", perl = TRUE) %>%
    gsub(pattern = "^EXTREME COLD.+", replacement = "EXTREME COLD", perl = TRUE) %>%
    gsub(pattern = "^EXTREME WIND CHILL$", replacement = "EXTREME WINDCHILL", perl = TRUE) %>%
    gsub(pattern = "^FLASH FLOOD.+", replacement = "FLASH FLOOD", perl = TRUE) %>%
    gsub(pattern = "^FREEZE.+", replacement = "FREEZE", perl = TRUE) %>%
    gsub(pattern = "^FREEZING.+", replacement = "FREEZE", perl = TRUE) %>%
    gsub(pattern = "^GUSTY WIND", replacement = "GUSTY WINDS", perl = TRUE) %>%
    gsub(pattern = "^HEAT WAVE.+", replacement = "HEAT WAVE", perl = TRUE) %>%
    gsub(pattern = "^HEAVY RAIN.+", replacement = "HEAVY RAIN", perl = TRUE) %>%
    gsub(pattern = "^HEAVY SNOW.+", replacement = "HEAVY SNOW", perl = TRUE) %>%
    gsub(pattern = "^FLOOD.+", replacement = "FLOOD", perl = TRUE) %>%
    gsub(pattern = "^RIVER FLOOD.+", replacement = "FLOOD", perl = TRUE) %>%
    gsub(pattern = "^FREEZE.+", replacement = "FREEZE", perl = TRUE) %>%
    gsub(pattern = "^FROST.+", replacement = "FROST", perl = TRUE) %>%
    gsub(pattern = "^GUSTY WINDS.+", replacement = "GUSTY WINDS", perl = TRUE) %>%
    gsub(pattern = "^HAIL.+", replacement = "HAIL", perl = TRUE) %>%
    gsub(pattern = "^HEAVY SURF.+", replacement = "HEAVY SURF", perl = TRUE) %>%
    gsub(pattern = "^HIGH SURF.+", replacement = "HIGH SURF", perl = TRUE) %>%
    gsub(pattern = "^HIGH WIND.+", replacement = "HIGH WIND", perl = TRUE) %>%
    gsub(pattern = "^HIGH$", replacement = "HIGH WIND", perl = TRUE) %>% ## see REMARKS
    gsub(pattern = "^HURRICANE.+", replacement = "HURRICANE", perl = TRUE) %>%
    gsub(pattern = "^HYPOTHERMIA.+", replacement = "HYPOTHERMIA", perl = TRUE) %>%
    gsub(pattern = "^ICE.+", replacement = "ICE", perl = TRUE) %>%
    gsub(pattern = "^ICY ROADS.+", replacement = "ICE", perl = TRUE) %>%
    gsub(pattern = "^LANDSLIDE.+", replacement = "LANDSLIDE", perl = TRUE) %>%
    gsub(pattern = "^LIGHTNING.+", replacement = "LIGHTNING", perl = TRUE) %>%
    gsub(pattern = "^RECORD/EXCESSIVE HEAT$", replacement = "RECORD HEAT", perl = TRUE) %>%
    gsub(pattern = "^RIP CURRENT.+", replacement = "RIP CURRENT", perl = TRUE) %>%
    gsub(pattern = "^SNOW.+", replacement = "SNOW", perl = TRUE) %>%
    gsub(pattern = "^STORM SURGE.+", replacement = "STORM SURGE", perl = TRUE) %>%
    gsub(pattern = "^STRONG WIND.+", replacement = "STRONG WIND", perl = TRUE) %>%
    gsub(pattern = "^THUNDERSTORM.*", replacement = "THUNDERSTORM WIND", perl = TRUE) %>%
    gsub(pattern = "^THUNDERTORM WINDS$", replacement = "THUNDERSTORM WIND", perl = TRUE) %>%
    gsub(pattern = "^TSTM WIND.*", replacement = "THUNDERSTORM WIND", perl = TRUE) %>%
    gsub(pattern = "^TORNADO.+", replacement = "TORNADO", perl = TRUE) %>%
    gsub(pattern = "^TROPICAL STORM.+", replacement = "TROPICAL STORM", perl = TRUE) %>%
    gsub(pattern = "^UNSEASONABLY WARM.+", replacement = "UNSEASONABLY WARM", perl = TRUE) %>%
    gsub(pattern = "^URBAN FLOOD.+", replacement = "URBAN/SML STREAM FLD", perl = TRUE) %>%
    gsub(pattern = "^URBAN SMALL.*", replacement = "URBAN/SML STREAM FLD", perl = TRUE) %>%
    gsub(pattern = "^URBAN/SMALL STREAM.*", replacement = "URBAN/SML STREAM FLD", perl = TRUE) %>%
    gsub(pattern = "^URBAN AND SMALL STREAM FLOODIN$", 
         replacement = "URBAN/SML STREAM FLD", perl = TRUE) %>%
    gsub(pattern = "^WATERSPOUT.+", replacement = "WATERSPOUT", perl = TRUE) %>%
    gsub(pattern = "^WILD.+", replacement = "WILDFIRE", perl = TRUE) %>%
    gsub(pattern = "^WIND.+", replacement = "WIND", perl = TRUE) %>%
    gsub(pattern = "^WINTER STORM.+", replacement = "WINTER STORM", perl = TRUE) %>%
    gsub(pattern = "^WINTER WEATHER.+", replacement = "WINTER WEATHER", perl = TRUE)
  
  output
}

## Calculates the DMG values by checking the EXP and update the DMG value
calculateDMG <- function(value, exp){
  output <- value
  
  if(as.numeric(value) > 0 && !is.null(exp)) {
    output <- switch(EXPR = as.character(exp),
           B =, b = value * 1000000000,
           M =, m = value * 1000000,
           K =, k = value * 1000,
           H =, h = value * 100,
           "+" =, "-" = value,
           "0" =, "2" =,"3" =, "6" =, "7" = value * 10 + as.numeric(exp), #Zero id 26267
           "5" = (value * 10 +5 ) * 1000,     ## see remarks 135k for ID 49238
           "4" = value * 1000000, ## see remark for ID 37895 (2.2M damages)
           value)
  }

  output
}
```

### Load Raw Data
```{r dataLoad, cache = TRUE}
downloadAndExtractZipFile(localZipFile)

data <- readCSVFile(localZipFile)
```

### Quick Data Summary
```{r summaryRawData}
str(data)
summary(data)
```

### Tidy Data
#### Cleanup data for the most harmful Storm Event Type
```{r tidyDataHarmfull, cache=FALSE}
## From the RawData we remove the rows that don't have injuries and fatalities, then select the columns EVTYPE, FATALITIES and INJURIES to have a reduced data set. After that we cleanup the EVTYPE column, group by the EVTYPE and calculate the the total FATALITIES and INJURIES per EVTYPE. Then we sort descendent the FATALITIES & INJURIES and pick the TOP 20
### MELT??????
tidyDataHarmful <- data[!(data$FATALITIES == 0 & data$INJURIES == 0), ] %>%
  select(EVTYPE, FATALITIES, INJURIES) %>%
  mutate(EVTYPE = cleanupEVTYPE(EVTYPE)) %>%
  group_by(EVTYPE) %>%
  summarise(FATALITIES = sum(FATALITIES), INJURIES = sum(INJURIES)) %>%
  arrange(desc(FATALITIES), desc(INJURIES)) %>%
  head(n = 10) %>%
  melt(id = c("EVTYPE"), variable.name = "TYPE")

str(tidyDataHarmful)
```

```{r summaryTidyDataHarmful}
summary(tidyDataHarmful)
```

#### Cleanup data for the most expensive Storm Event Type
```{r tidyDataDMG, cache=FALSE}
## From the RawData we remove the rows that don't have PROPERTY and CROP Damage, then select the columns EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG and CROPDMGEXP to have a reduced data set. After that we cleanup the EVTYPE column, calculate the real monetary damage for PROPERTY and CROP, group by the EVTYPE and calculate the the total monetary damage for PROPERTY and CROP per EVTYPE.
tidyDataDMG <- data[!(data$PROPDMG == 0 & data$CROPDMG == 0), ] %>%
  select(EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP) %>%
  mutate(EVTYPE = cleanupEVTYPE(EVTYPE)) %>%
  mutate(FINALPROPDMG = mapply(calculateDMG, PROPDMG, PROPDMGEXP), 
         FINALCROPDMG = mapply(calculateDMG, CROPDMG, CROPDMGEXP)) %>%
  group_by(EVTYPE) %>%
  summarise(TOTALPRODDMG = sum(FINALPROPDMG), 
            TOTALCROPDMG = sum(FINALCROPDMG))
##            TOTALDMG = TOTALPRODDMG + TOTALCROPDMG)

str(tidyDataDMG)
```

```{r summaryTidyDataDMG}
summary(tidyDataDMG)
```

## Results


####Questions
1) Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

```{r plotHarmfull, fig.width=9 }
plotHarmfull <- 
    ggplot(tidyDataHarmful, aes(x = reorder(EVTYPE, -value), y = value/1000, fill = TYPE)) +
    geom_bar(stat="identity", position="dodge") +
    theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
    labs( 
        y = "Number of people (thousands)", 
        x = "Storm Events",
      title = "Impact of Storm Events on the US Population Health - TOP 10")
    
print(plotHarmfull)
```


2) Across the United States, which types of events have the greatest economic consequences?

```{r plotDMGPROP, fig.width=9}

plotPropDMGData <- tidyDataDMG %>%
  select(EVTYPE, TOTALPRODDMG) %>%
  arrange(desc(TOTALPRODDMG)) %>%
  head(n=10)

plotCropDMGData <- tidyDataDMG %>%
  select(EVTYPE, TOTALCROPDMG) %>%
  arrange(desc(TOTALCROPDMG)) %>%
  head(n=10)

plotTotalDMGData <- tidyDataDMG %>%
  arrange(desc(TOTALPRODDMG), desc(TOTALCROPDMG)) %>%
  head(n=20) %>%
  melt(id=c("EVTYPE"), variable.name = "TYPE")

plotDMGPROP <- 
    ggplot(plotPropDMGData, aes(x = reorder(EVTYPE, -TOTALPRODDMG), y = TOTALPRODDMG)) +
    geom_bar(stat="identity", fill="blue") +
    theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
    labs( 
        y = "Dollares", 
        x = "Storm Events",
      title = "TOP 10 of events more costely")

plotCROPDMG <- 
    ggplot(plotCropDMGData, aes(x = reorder(EVTYPE, -TOTALCROPDMG), y = TOTALCROPDMG)) +
    geom_bar(stat="identity", fill="blue") +
    theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
    labs( 
        y = "Dollares", 
        x = "Storm Events",
      title = "TOP 10 of events more costely")

plotTOTALDMG <- 
    ggplot(plotTotalDMGData, aes(x = reorder(EVTYPE, -value), y = value, fill = TYPE)) +
    geom_bar(stat="identity") +
    theme(axis.text.x = element_text(angle = 70, hjust = 1)) +
    labs( 
        y = "Dollares", 
        x = "Storm Events",
      title = "TOP 20 of events more costely")

grid.arrange(plotDMGPROP, plotCROPDMG, ncol = 2)

print(plotTOTALDMG)
```



